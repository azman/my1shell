#!/bin/bash

# getslack
# - written by azman@my1matrix.org
# - a 'reduced' version of alien_bob's mirror_slackware_current.sh

TOOL_NAME=`basename $0 .sh`
# look for config file
for conf in `pwd`/.$TOOL_NAME $HOME/.$TOOL_NAME ; do
	[ -r $conf ] && source $conf && break
done
# setup path to slackware tree
[ -z "$SLACKROOT" ] && SLACKROOT=`pwd`
[ -z "$SLACKARCH" ] && [ -n "$ARCH" ] && SLACKARCH=$ARCH
[ -z "$SLACKARCH" ] && SLACKARCH=`uname -m`
[ "$SLACKARCH" == "x86_64" ] && SLACKSUFX="64" || SLACKSUFX=
[ -z "$SLACKNAME" ] && SLACKNAME="slackware$SLACKSUFX"
[ -z "$SLACKVERS" ] && [ -n "$VERS" ] && SLACKVERS=$VERS
[ -z "$SLACKVERS" ] && [ ! -f /etc/slackware-version ] && SLACKVERS="current" ||
	SLACKVERS=`cat /etc/slackware-version | sed 's/Slackware //'`
SLACKFULL=$SLACKNAME-$SLACKVERS
SLACKTREE=$SLACKROOT/$SLACKFULL
# setup rsync stuffs
RSYNC_BIN=`which rsync 2>/dev/null`
[ "$RSYNC_BIN" == "" ] && echo "Cannot find rsync!" && exit 1
[ -z "$RSYNCURLROOT" ] && RSYNCURLROOT="slackware.mirrors.tds.net::slackware/"
RSYNC_URL="$RSYNCURLROOT$SLACKFULL/"
RSYNC_OPT="--delete --delete-excluded --partial -rlptD --progress"
# start actual mirroring process - reduced version of alien_bob's script
echo -e "#\n# Checking and changing to $SLACKTREE ...\n#"
[ ! -d $SLACKTREE ] && mkdir -pv $SLACKTREE ; cd $SLACKTREE
echo "*** Using $RSYNC_URL ***"
$RSYNC_BIN $RSYNC_OPT $INCLUDES $EXCLUDES $RSYNC_URL $SLACKTREE
echo "*** Using $RSYNC_URL - (2nd Run) ***"
$RSYNC_BIN $RSYNC_OPT $INCLUDES $EXCLUDES $RSYNC_URL $SLACKTREE
echo `date`" [$$]: Done mirroring $SLACKFULL (exit code $?)."
exit 0
