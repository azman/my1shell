#!/bin/bash

# libmy1slack (by azman@my1matrix.net)
# -> library function for my1slack system management

MY1_LIBNAME="libmy1slack"
MY1_LIBVERS="2011.12.00"
MY1_LIBCALL="$(basename $0 .sh)"

# determine slackware architecture, NOT machine's!
SLACKARCH=""
[[ "$(find / -maxdepth 1 -name 'lib64' -type d 2>/dev/null)" == "/lib64" ]] && SLACKARCH="64"
SLACKNAME="slackware$SLACKARCH"
# get slackware release version - not sure if current is supported!
SLACKVERS=${SLACKVERS:=""}
if [[ "$SLACKVERS" == "" ]]; then
	SLACKVERS=$(cat /etc/slackware-version) # always in the form of "Slackware x.x.x"?
	SLACKVERS=${SLACKVERS#Slackware }
	SLACKVERS=${SLACKVERS//${SLACKVERS#*.*.}/}
	SLACKVERS=${SLACKVERS:0:${#SLACKVERS}-1}
fi
# default path to look for
SLACKFIND=${SLACKFIND:="/home"}
# find slackware tree
SLACKRELEASE="$SLACKNAME-$SLACKVERS"
SLACKROOTDIR=${SLACKROOTDIR:=""}
if [[ "$SLACKROOTDIR" == "" ]]; then
	SLACKROOTDIR=$(find $SLACKFIND -maxdepth 3 -name "$SLACKRELEASE" -type d 2>/dev/null)
	SLACKROOTDIR=${SLACKROOTDIR%"/$SLACKRELEASE"}
fi
SLACKRELPATH=${SLACKRELPATH:="${SLACKROOTDIR}/${SLACKRELEASE}"}
SLACKPKGPATH=${SLACKPKGPATH:="${SLACKRELPATH}/slackware$SLACKARCH"}
SLACKPKGFILE=${SLACKPKGFILE:="${SLACKPKGPATH}/PACKAGES.TXT"}
SLACKINSTLOG="/var/log/packages"

if [[ "$MY1_DEBUG" == "YES" ]]; then
	echo
	echo "[DEBUG-$$] ==> my1slack Library Name is $MY1_LIBNAME"
	echo "[DEBUG-$$] ==> my1slack Library Version is $MY1_LIBVERS"
	echo "[DEBUG-$$] ==> Slack Release is $SLACKRELEASE"
	echo "[DEBUG-$$] ==> Slack Tree is at $SLACKROOTDIR"
	echo "[DEBUG-$$] ==> Command Call '$MY1_LIBCALL'"
fi

function get_pkg_info()
{
	# get pkg info from name (i.e. filename minus extension!)
	local pkg_name pkg_vers pkg_arch pkg_extd pkg_temp
	local pkg_base="$1"
	pkg_extd="${pkg_base##*-}"
	pkg_temp="${pkg_base%-${pkg_extd}}"
	pkg_arch="${pkg_temp##*-}"
	pkg_temp="${pkg_temp%-${pkg_arch}}"
	pkg_vers="${pkg_temp##*-}"
	pkg_name="${pkg_temp%-${pkg_vers}}"
	echo -n "$pkg_name $pkg_vers $pkg_arch $pkg_extd"
}

function get_softpack()
{
	local pkg_list
	local pkg_pack="${SLACKPKGPATH}/$1"
	if [[ -d $pkg_pack ]]; then
		cd $pkg_pack
		for pkg_file in *.t[gx]z; do
			pkg_list="$pkg_list ${pkg_file%.t[gx]z}"
		done
	fi
	echo -n "$pkg_list"
}

function comp_package()
{
	local pkg1_file="$1"
	local pkg2_file="$2"
	local pkg_temp
	local pkg1_name pkg1_vers pkg1_arch pkg1_extd
	local pkg2_name pkg2_vers pkg2_arch pkg2_extd

	pkg_temp=($(get_pkg_info $pkg1_file))
	pkg1_name="${pkg_temp[0]}"
	pkg1_vers="${pkg_temp[1]}"
	pkg1_arch="${pkg_temp[2]}"
	pkg1_extd="${pkg_temp[3]}"
	pkg_temp=($(get_pkg_info $pkg2_file))
	pkg2_name="${pkg_temp[0]}"
	pkg2_vers="${pkg_temp[1]}"
	pkg2_arch="${pkg_temp[2]}"
	pkg2_extd="${pkg_temp[3]}"

	[[ "$pkg1_name" == "$pkg2_name" ]] || return 1
	[[ "$pkg1_vers" == "$pkg2_vers" ]] || return 2
	[[ "$pkg1_arch" == "$pkg2_arch" ]] || return 3
	[[ "$pkg1_extd" == "$pkg2_extd" ]] || return 4

	return 0
}

function pkg_db_package()
{
	local pkg_name="$1"
	local pkg_flag="$2"
	local pkg_info pkg_long pkg_file pkg_path
	local pkg_size pkg_full pkg_base pkg_desc
	local pkg_temp="\<PACKAGE NAME:  ${pkg_name}-[^-]*-[^-]*-[^-]*\.t[gx]z\>"
	local pkg_test=$(cat $SLACKPKGFILE | grep -e "$pkg_temp" -A3)
	[[ "$pkg_test" = "" ]] && return 1
	[[ "$pkg_flag" == "--check" ]] && echo -n "$pkg_name" && return 0

	# extract info
	pkg_file=$(echo "$pkg_test" | grep 'PACKAGE NAME')
	pkg_file="${pkg_file##* }"
	pkg_path=$(echo "$pkg_test" | grep 'PACKAGE LOCATION')
	pkg_path="${pkg_path##*./}"
	pkg_size=$(echo "$pkg_test" | grep 'PACKAGE SIZE (compressed)')
	pkg_size="${pkg_size%% K*}"
	pkg_size="${pkg_size##* }K"
	pkg_full=$(echo "$pkg_test" | grep 'PACKAGE SIZE (uncompressed)')
	pkg_full="${pkg_full%% K*}"
	pkg_full="${pkg_full##* }K"
	pkg_base=${pkg_file%.t[gx]z}
	[[ "$pkg_flag" == "--all" ]] && pkg_desc=$(grep "$pkg_name:" $SLACKPKGFILE)
	# build db
	eval pkgfile_${pkg_name//[-.]/_}="$pkg_file"
	eval pkgpath_${pkg_name//[-.]/_}="$pkg_path"
	eval pkgsize_${pkg_name//[-.]/_}="$pkg_size"
	eval pkgfull_${pkg_name//[-.]/_}="$pkg_full"
	eval pkgbase_${pkg_name//[-.]/_}="$pkg_base"
	eval pkgdesc_${pkg_name//[-.]/_}='$pkg_desc'

	return 0
}

function pkg_db_install()
{
	local pkg_name="$1"
	local pkg_flag="$2"
	local pkg_base pkg_file pkg_path
	local pkg_size pkg_full
	local pkg_temp="\<${pkg_name}-[^-]*-[^-]*-[^-]*$"
	local pkg_test=$(ls $SLACKINSTLOG | grep -e "$pkg_temp")
	[[ "$pkg_test" = "" ]] && return 1
	[[ "$pkg_flag" == "--check" ]] && echo -n "$pkg_name" && return 0

	# extract info
	pkg_temp="$SLACKINSTLOG/$pkg_test"
	pkg_test=$(cat $pkg_temp | grep -e "^PACKAGE NAME:" -A3)
	pkg_base=$(echo "$pkg_test" | grep 'PACKAGE NAME')
	pkg_base="${pkg_base##* }"
	pkg_file=$(echo "$pkg_test" | grep 'PACKAGE LOCATION')
	pkg_file="${pkg_file##* }"
	pkg_path=${pkg_file%${pkg_base}.t[gx]z}
	[[ "$pkg_path" == "" ]] || pkg_file=${pkg_file##${pkg_path}}
	pkg_size=$(echo "$pkg_test" | grep -e "^COMPRESSED PACKAGE SIZE")
	pkg_size="${pkg_size##* }"
	pkg_full=$(echo "$pkg_test" | grep -e "^UNCOMPRESSED PACKAGE SIZE")
	pkg_full="${pkg_full##* }"
	[[ "$pkg_flag" == "--all" ]] && pkg_desc=$(grep "$pkg_name:" $pkg_temp)
	# build db
	eval pkgfile_${pkg_name//[-.]/_}="$pkg_file"
	eval pkgpath_${pkg_name//[-.]/_}="$pkg_path"
	eval pkgsize_${pkg_name//[-.]/_}="$pkg_size"
	eval pkgfull_${pkg_name//[-.]/_}="$pkg_full"
	eval pkgbase_${pkg_name//[-.]/_}="$pkg_base"
	eval pkgdesc_${pkg_name//[-.]/_}='$pkg_desc'

	return 0
}

function find_infile()
{
	local pkg_base="$1"
	local pkg_test="$2"
	local pkg_temp="\<${pkg_test}-[^-]*-[^-]*-[^-]*$"
	local pkg_file=$(cat $pkg_base | grep -e "$pkg_temp")
	echo -n "$pkg_file"
}

function find_inpath()
{
	local pkg_test="$1"
	local tgt_path="$2"
	[[ -d "$tgt_path" ]] || tgt_path="."
	local pkg_temp="\<${pkg_test}-[^-]*-[^-]*-[^-]*\.t[gx]z\>"
	local pkg_file=$(find $tgt_path -name *.t[gx]z | grep -e "$pkg_temp")
	echo -n "$pkg_file"
}

function find_install()
{
	local pkg_test="$1"
	local pkg_temp="\<${pkg_test}-[^-]*-[^-]*-[^-]*$"
	local pkg_file=$(ls $SLACKINSTLOG | grep -e "$pkg_temp")
	echo -n "$pkg_file"
}

function find_package()
{
	local pkg_test="$1"
	local pkg_temp="\<PACKAGE NAME:  ${pkg_test}-[^-]*-[^-]*-[^-]*\.t[gx]z\>"
	local pkg_file=$(cat $SLACKPKGFILE | grep -e "$pkg_temp")
	local pkg_file="${pkg_file##* }"
	[[ "$pkg_file" != "" ]] && pkg_file="${pkg_file%.t[gx]z}"
	echo -n "$pkg_file"
}

function show_info()
{
	local pkg_test="$1"
	local pkg_path pkg_size pkg_full
	local pkg_stat pkg_flag pkg_base
	local pkg_temp pkg_desc pkg_log pkg_file
	local pkg_name pkg_vers pkg_arch pkg_extd

	pkg_temp="pkgbase_${pkg_test//-/_}"
	[[ -z "${!pkg_temp}" ]] && return
	pkg_base="${!pkg_temp}"
	pkg_temp=($(get_pkg_info $pkg_base))
	pkg_name="${pkg_temp[0]}"
	pkg_vers="${pkg_temp[1]}"
	pkg_arch="${pkg_temp[2]}"
	pkg_extd="${pkg_temp[3]}"
	pkg_temp="pkgfile_${pkg_test//-/_}"
	pkg_file="${!pkg_temp}"
	pkg_temp="pkgpath_${pkg_test//-/_}"
	pkg_path="${!pkg_temp}"
	pkg_temp="pkgsize_${pkg_test//-/_}"
	pkg_size="${!pkg_temp}"
	pkg_temp="pkgfull_${pkg_test//-/_}"
	pkg_full="${!pkg_temp}"
	pkg_temp="pkgdesc_${pkg_test//-/_}"
	pkg_desc="${!pkg_temp}"
	[[ "$pkg_path" == "" ]] && pkg_path="Unknown"
	[[ "$pkg_size" == "" ]] && pkg_size="Unknown"
	[[ "$pkg_full" == "" ]] && pkg_full="Unknown"

	if [[ "$(find_install $pkg_name)" == "" ]]; then
		pkg_flag="NOT "
	else
		pkg_flag=""
	fi
	if [[ "$(find_package $pkg_name)" == "" ]]; then
		pkg_stat=" (ALIEN!)"
	else
		pkg_stat=""
	fi
	local title="PACKAGE <$pkg_name> - BEGIN"
	local trail="PACKAGE <$pkg_name> - END"
	for (( a=0;a<${#title};a++ )) ; do echo -n "-"; done ; echo
	echo "$title"
	for (( a=0;a<${#title};a++ )) ; do echo -n "-"; done ; echo
	echo "FILE               : ${pkg_file}${pkg_stat}"
	echo "INSTALL PATH       : $pkg_path"
	echo "VERSION            : $pkg_vers"
	echo "ARCHITECTURE       : $pkg_arch"
	echo "BUILD TAG          : $pkg_extd"
	echo "SIZE (Compressed)  : $pkg_size"
	echo "SIZE (Uncompressed): $pkg_full"
	echo "INSTALL STATUS     : ${pkg_flag}INSTALLED"
	echo "DESCRIPTION        :"
	echo -e "$pkg_desc"
	for (( a=0;a<${#trail};a++ )) ; do echo -n "-"; done ; echo
	echo "$trail"
	for (( a=0;a<${#trail};a++ )) ; do echo -n "-"; done ; echo ; echo
}

function find_alien_pkgs()
{
	local pkg_list pkg_name

	# find installed
	for pkg_base in $(ls $SLACKINSTLOG); do
		pkg_name="${pkg_base%-*-*-*}"
		# find if alien
		[[ "$(find_package $pkg_name)" == "" ]] && pkg_list="$pkg_list $pkg_base"
	done

	echo -n "$pkg_list"
}

function find_datab_pkg()
{
	# find package from db, if not found create entry!
	local pkg_name="$1"
	local pkg_temp pkg_base

	pkg_temp="pkgbase_${pkg_name//-/_}"
	[[ -z "${!pkg_temp}" ]] && pkg_db_package $pkg_name
	[[ -z "${!pkg_temp}" ]] && pkg_db_install $pkg_name
	[[ -z "${!pkg_temp}" ]] && return 1
	pkg_base="${!pkg_temp}"

	echo -n "$pkg_base"
	return 0
}

function format_text()
{
	local begin="\033[0m"
	local end="\033[0m"
	local bold="\033[1m"
	local uline="\033[4m"
	local blink="\033[5m"
	local inverse="\033[7m"
	local concealed="\033[8m"
	local color=""
	local black="\033[30m"
	local red="\033[31m"
	local green="\033[32m"
	local yellow="\033[33m"
	local blue="\033[34m"
	local magenta="\033[35m"
	local cyan="\033[36m"
	local white="\033[37m"
	local text=""

	while [ "$1" != "" ]; do
		case "$1" in
		--bold) begin="${begin}${bold}" ;;
		--blink) begin="${begin}${blink}" ;;
		--color)
			shift; color="$1"
			case "$color" in
				black) color="$black" ;;
				red) color="$red" ;;
				green) color="$green" ;;
				yellow) color="$yellow" ;;
				blue) color="$blue" ;;
				magenta) color="$magenta" ;;
				cyan) color="$cyan" ;;
				white) color="$white" ;;
				*) color="$black" ;;
			esac
			begin="${begin}${color}";;
		--text)
			shift; text="$1";;
		esac
		shift
	done	
	echo -e "$begin""$text""$end"
}

function test_param()
{
	local test="$1"
	echo "Param @ is $@"
	echo "Param * is $*"
	echo "Param 1 is $1"
	echo "Param test is $test"
	shift
	echo "Params shifted by 1!"
	test="$1"
	echo "Param @ is $@"
	echo "Param * is $*"
	echo "Param 1 is $1"
	echo "Param test is $test"
	shift
	echo "Param \$ is $$"
}
