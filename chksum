#!/bin/bash

# chksum
# - written by azman@my1matrix.net
# - create and check MD5 sum hashes

CURR_PATH=`pwd`
THAT_NAME=${THAT_NAME:="md5"}
THAT_EXEC=${THAT_EXEC:="${THAT_NAME}sum"}
THAT_FILE=${THAT_FILE:="check.${THAT_NAME}"}

# check if sha256 requested
if [ "$(echo $@|grep -- '--sha256')" != "" ]; then
	THAT_NAME="sha256"
	THAT_EXEC="${THAT_NAME}sum"
	THAT_FILE="check.${THAT_NAME}"
elif [ "$(echo $@|grep -- '--sha512')" != "" ]; then
	THAT_NAME="sha512"
	THAT_EXEC="${THAT_NAME}sum"
	THAT_FILE="check.${THAT_NAME}"
fi

# find binary
THAT_FULL=`which $THAT_EXEC 2>/dev/null`
[ "$THAT_FULL" = "" ] &&
	echo "$THAT_EXEC binary NOT found! Aborting!" && exit 1

if [ "$(echo $@|grep -- '--create')" != "" ]; then
	if [ "$(echo $@|grep -- '--bundle')" == "" ]; then
		THAT_LIST=""
		while [ "$1" != "" ] ; do
			[ -f $1 ] && THAT_LIST="$THAT_LIST $1"
			shift
		done
		[ "$THAT_LIST" == "" ] &&
			THAT_LIST=`find . -maxdepth 1 -type f | sort`
		for temp in $THAT_LIST ; do
			TEMP_FILE=`basename $temp`
			flag=`echo $TEMP_FILE|grep "$THAT_NAME"`
			[ "$flag" != "" ] && continue
			echo -n "Creating checksum for $TEMP_FILE... "
			$THAT_FULL $TEMP_FILE >$temp.$THAT_NAME
			echo "done."
		done
	else
		echo -n "" >$THAT_FILE
		for temp in `find . -type f | sort`; do
			TEMP_FILE=`basename $temp`
			[ "$TEMP_FILE" == "$THAT_FILE" ] && continue
			TEMP_PICK=`echo $temp | sed 's|^\./\(.*\)$|\1|'`
			echo -n "Creating checksum for $TEMP_PICK... "
			$THAT_FULL $TEMP_PICK >>$THAT_FILE
			echo "done. ($THAT_FILE)"
		done
	fi
else
	if [ -r "$THAT_FILE" ] ; then
		$THAT_FULL --check $THAT_FILE
		[ $? -ne 0 ] && echo "Checksum error found?!" && exit 1
	else
		THAT_LIST=`find $CURR_PATH -maxdepth 1 -name "*.$THAT_NAME"`
		[ "$THAT_LIST" == "" ] &&
			echo "Cannot find any $THAT_NAME sum file!" && exit 0
		for temp in $THAT_LIST; do
			echo -n "Checking... "
			$THAT_FULL --check $temp
			[ $? -ne 0 ] && echo "sum error?! ($temp)" && continue
		done
	fi
fi

exit 0
