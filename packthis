#!/bin/bash

# packthis
# - written by azman@my1matrix.net
# - to pack current working directory

CURRPATH=$(pwd)
WORKPATH=$(dirname $CURRPATH)
BALLPATH=$HOME/temp
BALLNAME=$(basename $CURRPATH)
NAMESUFX=${NAMESUFX:=""}
BALLSUFX=${BALLSUFX:=""}
DATE_FMT=${DATE_FMT:="+%Y%m%d"}
CHECKGIT=${CHECKGIT:="YES"}
BUNDLGIT=${BUNDLGIT:="NO"}
PATCHGIT=${PATCHGIT:="NO"}
PATCHNUM=${PATCHNUM:="4"}
CHK_VERB=${CHK_VERB:="NO"}
NUM_COPY=${NUM_COPY:=0}
TAR_EXEC=${TAR_EXEC:="tar"}
TAR_OPTS=${TAR_OPTS:="czf"}
TAR_EXTN=${TAR_EXTN:=".tar.gz"}
ZIP_EXEC=${ZIP_EXEC:="zip"}
ZIP_OPTS=${ZIP_OPTS:="-rq"}
ZIP_EXTN=${ZIP_EXTN:=".zip"}
DO_GZ=${DO_GZ:="NO"}
DO_ZIP=${DO_ZIP:="NO"}
CHK_EXEC=
CHK_NAME=
CHK_COPY=
CHK_EXTN=

while [ "$1" != "" ]; do
	case $1 in
		--suffix)
			shift
			NAMESUFX="-$1"
			;;
		--time)
			DATE_FMT="+%Y%m%d%H%M"
			;;
		--ignore-git)
			CHECKGIT="NO"
			;;
		--bundle-git|--git)
			CHECKGIT="NO"
			BUNDLGIT="YES"
			PATCHGIT="NO"
			;;
		--git-all)
			CHECKGIT="ALL"
			BUNDLGIT="YES"
			PATCHGIT="NO"
			;;
		--git-patch|--patch-git)
			CHECKGIT="NO"
			BUNDLGIT="YES"
			PATCHGIT="YES"
			shift
			PATCHNUM=$1
			;;
		--git-diff)
			CHECKGIT="NO"
			BUNDLGIT="NO"
			PATCHGIT="YES"
			;;
		--verbose|-v)
			CHK_VERB="YES"
			;;
		--path)
			shift
			[ ! -d "$1" ] && echo "Path '$1' not found!"
			[ -d "$1" ] && BALLPATH=$(cd $1;pwd)
			;;
		--zip)
			DO_ZIP="YES"
			;;
		--gz)
			DO_GZ="YES"
			;;
		* )
			echo "Unknown parameter ($1)!" && exit 1
			;;
	esac
	shift
done

# use xz when available AND gz not specifically requested
[ "$(which xz 2>/dev/null)" != "" -a "$DO_GZ" != "YES" ] &&
	TAR_OPTS=${TAR_OPTS//z/J} && TAR_EXTN=${TAR_EXTN//gz/xz}

[ "$CHK_VERB" == "YES" ] && TAR_OPTS="${TAR_OPTS}v"
[ "$CHK_VERB" == "YES" ] && ZIP_OPTS="${ZIP_OPTS//q/}"

[ ! -d $BALLPATH ] && mkdir -pv $BALLPATH

if [ "$BUNDLGIT" == "YES" ]; then
	[ ! -d "$CURRPATH/.git" ] &&
		echo "Not a git repo! Cannot use git stuffs!" && exit 1
	if [ "$PATCHGIT" == "YES" ]; then
		BALLSUFX="${BALLSUFX}_patches"
		CHK_NAME=${BALLNAME}${NAMESUFX}-$(date ${DATE_FMT})${BALLSUFX}
		rm -rf ${BALLPATH}/${CHK_NAME}
		#CHK_PREV="$(printf "HEAD%*s" $PATCHNUM "" | tr ' ' '^')";
		#git bundle create ${BALLPATH}/${CHK_NAME} ${CHK_PREV} HEAD
		git format-patch -o ${BALLPATH}/${CHK_NAME} -${PATCHNUM}
		[ $? -ne 0 ] && echo "Error running git?" && exit 1
	else
		if [ "$CHECKGIT" == "ALL" ] ; then
			CHK_BRANCH="--branches --tags"
		else
			CHK_BRANCH="$(git branch|grep "* ")"
			CHK_BRANCH="${CHK_BRANCH#* }"
			BALLSUFX="${BALLSUFX}_${CHK_BRANCH}"
		fi
		CHK_NAME=${BALLNAME}${NAMESUFX}-$(date ${DATE_FMT})${BALLSUFX}.git
		git bundle create ${BALLPATH}/${CHK_NAME} ${CHK_BRANCH}
		[ $? -ne 0 ] && echo "Error running git?" && exit 1
	fi
	exit 0
fi

if [ "$PATCHGIT" == "YES" ]; then
	[ ! -d "$CURRPATH/.git" ] &&
		echo "Not a git repo! Cannot use git stuffs!" && exit 1
	BALLSUFX="${BALLSUFX}_git"
	CHK_NAME=${BALLNAME}${NAMESUFX}-$(date ${DATE_FMT})${BALLSUFX}.patch
	git diff >${BALLPATH}/${CHK_NAME}
	[ $? -ne 0 ] && echo "Error running git?" && exit 1
	exit 0
fi

[ -L "$CURRPATH" ] && CURRPATH=$(pwd -P) && WORKPATH=$(dirname $CURRPATH)

if [ -d $WORKPATH ]; then
	cd $WORKPATH
	[ "$CHK_VERB" == "NO" ] && echo -n "Archiving ... "
	if [ "$DO_ZIP" == "YES" ]; then
		CHK_EXEC="${ZIP_EXEC} ${ZIP_OPTS}"
		CHK_EXTN=${ZIP_EXTN}
	else
		CHK_EXEC="${TAR_EXEC} ${TAR_OPTS}"
		CHK_EXTN=${TAR_EXTN}
	fi
	[ "$CHECKGIT" != "NO" ] &&
		[ -d "$CURRPATH/.git" ] && BALLSUFX="${BALLSUFX}_git"
	CHK_NAME=${BALLNAME}${NAMESUFX}
	CHK_COPY=${BALLSUFX}${CHK_EXTN}
	while [ -f ${BALLPATH}/${CHK_NAME}-$(date ${DATE_FMT})${CHK_COPY} ]; do
		(( NUM_COPY=NUM_COPY+1 ))
		CHK_COPY="${BALLSUFX}_${NUM_COPY}${CHK_EXTN}"
	done
	CHK_EXTN=${CHK_COPY}
	CHK_NAME=${CHK_NAME}-$(date ${DATE_FMT})${CHK_EXTN}
	${CHK_EXEC} ${BALLPATH}/${CHK_NAME} ${BALLNAME}
	[ "$CHK_VERB" == "NO" ] && echo "done."
fi
