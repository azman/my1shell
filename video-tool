#!/bin/bash

XFILE=`basename $0 .sh`
IFILE="$1"
OFILE="${IFILE%.*}.avi"
TWICE=""

[ "$1" = "" ] && exit 0
[ "$2" = "--dual" ] && TWICE="YES"
[ "$IFILE" = "$OFILE" ] && OFILE="${IFILE%.*}-conv.avi"

GOPTS="-sn" # disable subtitle
# audio options
AOPTS="-c:a libmp3lame -ar 48000 -ab 128k"
# simpler?
#AOPTS="-c:a libmp3lame -qscale:a 4"
# video options
VOPTS="-c:v mpeg4 -vtag xvid -vf scale=704:304 -aspect 16:9 -vb 700k -r 25"
#CONSIDER THIS!! maybe slightly higher qscale? 0 is too big?
#VOPTS="-c:v mpeg4 -vtag xvid -vf scale=704:304 -r 25 -qscale:v 0"
# simpler?
#VOPTS="-c:v mpeg4 -vtag xvid -qscale:v 3 -b:v 700k"
# if using external xvidcore?
#VOPTS="-c:v libxvid -vf scale=704:304 -aspect 16:9 -vb 700k -r 25"
# -qscale:v 0 is for mpegX stuffs
# opt -crf 18 is for libx264!
INIT1="-y"
INIT2=""
PASS1="-pass 1 ${GOPTS} ${AOPTS} ${VOPTS} -an -f avi /dev/null"
PASS2="-pass 2 ${GOPTS} ${AOPTS} ${VOPTS} ${OFILE}"

echo "Input : $IFILE"
echo "Output: $OFILE"
[ ! -f "$IFILE" ] && exit 0
[ -f "$OFILE" ] && echo -ne "\n[ABORT] Output file exists!\n\n" && exit 0

echo -n "" >${XFILE}.log
if [ "$TWICE" != "YES" ]; then
	ffmpeg -i ${IFILE} ${GOPTS} ${AOPTS} ${VOPTS} ${OFILE} 2>>${XFILE}.log
else
	ffmpeg ${INIT1} -i ${IFILE} ${PASS1} 2>>${XFILE}.log
	ffmpeg ${INIT2} -i ${IFILE} ${PASS2} 2>>${XFILE}.log
fi
