#!/bin/bash

# slack-update
# - written by azman@my1matrix.org
# - get updates for slackware system
# - requires getslack, getslackpack, getslackbuild scripts

# standard tool info
TOOL_NAME=`basename $0`
TOOL_PATH=`dirname $0`
TOOL_PATH=`cd $TOOL_PATH ; pwd`
CURR_PATH=`pwd`
TOOL_DESC="my1 Slackware Update Tool"
TOOL_VERS="2019.08.00"
DO_NOTIFY="$HOME/temp/$TOOL_NAME-PATCH"

echo -ne "\n$TOOL_NAME - $TOOL_DESC ($TOOL_VERS)\n\n"

source_lib()
{
	local name=$1
	local full=$TOOL_PATH/$name
	[ ! -f "$full" ] && echo "Cannot find $full!" && exit 1
	. $full
}
source_lib libmy1slack

# make sure we are in correct path
SLACKTREE=`find_slack | cut -d':' -f4`
[ ! -d "$SLACKTREE" ] && echo "Cannot find slack @'$SLACKTREE'!" && exit 1
cd `dirname $SLACKTREE`

# find/get the updates
$TOOL_PATH/getslack
$TOOL_PATH/getslackpack --sweep --exec
$TOOL_PATH/getslackbuild fresh
$TOOL_PATH/getslackbuild check | grep PATCH

do_notify()
{
	echo -ne  "\n-----------------"
	echo -ne  "\nWE NEED TO PATCH!"
	echo -ne  "\n-----------------\n"
	mkdir -p `dirname $DO_NOTIFY`
	$TOOL_PATH/slackpatch |
		sed -n '/Packages need updating:/,/^$/{/^$/!p}' >$DO_NOTIFY
}

# do we need to patch?
$TOOL_PATH/slackpatch quiet
[ $? -ne 0 ] && do_notify

cd $CURR_PATH
echo ; exit 0
