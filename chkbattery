#!/bin/bash

# chkbattery
# - written by azman@my1matrix.net
# - simple script to check battery from /proc/acpi

ACPI_PATH="/proc/acpi/battery"
BATT_MISS="YES"

if [ -d ${ACPI_PATH} ] ; then
	BATT_PATH="$(find ${ACPI_PATH} -name "BAT*" -maxdepth 1 -type d)"
	BATT_PATH="${BATT_PATH%% *}"
	BATT_NAME="${BATT_PATH#${ACPI_PATH}/}"
	if [ ${BATT_NAME} != "" ] ; then
		TEST_BATT=$(cat ${BATT_PATH}/state | grep "present:")
		TEST_BATT=${TEST_BATT##*  }
		TEST_BATT=${TEST_BATT% *}
		[ "$TEST_BATT" != "no" ] && BATT_MISS="NO"
	fi
fi

if [ "$BATT_MISS" == "NO" ] ; then
	FULL_BATT=$(cat ${BATT_PATH}/info | grep "design capacity:")
	FULL_BATT=${FULL_BATT##*  }
	FULL_BATT=${FULL_BATT% *}
	PREV_BATT=$(cat ${BATT_PATH}/info | grep "last full capacity:")
	PREV_BATT=${PREV_BATT##*  }
	PREV_BATT=${PREV_BATT% *}
	CURR_BATT=$(cat ${BATT_PATH}/state | grep "remaining capacity:")
	CURR_BATT=${CURR_BATT##*  }
	CURR_BATT=${CURR_BATT% *}
	((CURR_PCTG=${CURR_BATT}*100/${PREV_BATT}))
	RATE_BATT=$(cat ${BATT_PATH}/state | grep "present rate:")
	RATE_BATT=${RATE_BATT##*  }
	RATE_BATT=${RATE_BATT% *}
	_CHARGING=$(cat ${BATT_PATH}/state | grep "charging state:")
	_CHARGING=${_CHARGING##*  }
	if [ "$_CHARGING" == "discharging" ] ; then
		if [ "$RATE_BATT" == "unknown" ] ; then
			CHK_STATE="$CURR_PCTG%??"
			_CHARGING="$_CHARGING:(unknown)"
		elif [ "$RATE_BATT" -eq 0 ] ; then
			CHK_STATE="$CURR_PCTG%**"
			_CHARGING="$_CHARGING:AC"
		else
			((TIME1PART=${CURR_BATT}/${RATE_BATT}))
			if [ $TIME1PART -ne 0 ] ; then
				((TIME2PART=${CURR_BATT}-${TIME1PART}*${RATE_BATT}))
				TIME2LIVE="${TIME1PART}H"
			else
				TIME2PART=${CURR_BATT}
				TIME2LIVE=""
			fi
			((TIME2PART=${TIME2PART}*60/${RATE_BATT}))
			TIME2LIVE="${TIME2LIVE}${TIME2PART}M"
			CHK_STATE="$CURR_PCTG%-- ($TIME2LIVE)"
			_CHARGING="$_CHARGING:${TIME2LIVE}"
		fi
	elif [ "$_CHARGING" == "charging" ] ; then
		if [ "$RATE_BATT" == "unknown" ] ; then
			CHK_STATE="$CURR_PCTG%??"
			_CHARGING="$_CHARGING:(unknown)"
		elif [ "$RATE_BATT" -eq 0 ] ; then
			CHK_STATE="$CURR_PCTG%**"
			_CHARGING="$_CHARGING:AC"
		else
			((LEFT_BATT=${FULL_BATT}-${CURR_BATT}))
			((TIME1PART=${LEFT_BATT}/${RATE_BATT}))
			if [ $TIME1PART -ne 0 ] ; then
				((TIME2PART=${LEFT_BATT}-${TIME1PART}*${RATE_BATT}))
				TIME2FULL="${TIME1PART}H"
			else
				TIME2PART=${LEFT_BATT}
				TIME2FULL=""
			fi
			((TIME2PART=${TIME2PART}*60/${RATE_BATT}))
			TIME2FULL="${TIME2FULL}${TIME2PART}M"
			CHK_STATE="$CURR_PCTG%++ ($TIME2FULL)"
			_CHARGING="$_CHARGING:${TIME2FULL}"
		fi
	elif [ "$_CHARGING" == "charged" ] ; then
		CHK_STATE="$CURR_PCTG%##"
	else
		CHK_STATE="$CURR_PCTG%??"
	fi
else
	CURR_BATT="0"
	FULL_BATT="0"
	PREV_BATT="0"
	RATE_BATT="0"
	CURR_PCTG="100"
	_CHARGING="No battery!"
	CHK_STATE="AC"
fi

[ "$1" == "--state" ] && echo "$CHK_STATE" && exit 0

echo "$CURR_PCTG% <$_CHARGING> CURR=$CURR_BATT RATE=$RATE_BATT" \
	"FULL=$FULL_BATT PREV=$PREV_BATT [${BATT_NAME}]"

exit 0
