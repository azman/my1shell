#!/bin/bash

ROOT_PATH=${ROOT_PATH:="/opt/chroot32"}
BIND_THIS="proc sys home dev"

[ $UID -ne 0 ] && echo "Must run as root!" && exit 1

for path in ${BIND_THIS} ; do
	target=${ROOT_PATH}/$path
	[ ! -d "$target" ] && echo "Cannot find $target! Ignored!" && continue
	[ ! -d "/$path" ] && echo "Cannot find /$path! Ignored!" && continue
	dotest=`mount | grep $target`
	if [ "$1" == "--release" ] ; then
		[ "$dotest" == "" ] && continue
		if [ "$path" = "dev" ] ; then
			# unbind ${ROOT_PATH}/dev 'recursively'
			checks=`cat /proc/mounts|awk '{print $2}'|grep ${target}/|sort -r`
			for rmnt in $checks ; do
				echo "Release rbinded $rmnt"
				umount -n $rmnt
			done
		fi
		echo "Release bind to /$path at $target"
		umount $target
	else
		[ "$dotest" != "" ] && continue
		dobind="bind"
		[ "$path" = "dev" ] && dobind="rbind"
		echo "Create $dobind to /$path at $target"
		mount --$dobind /$path $target
	fi
done

# special case for resolv.conf
BIND_FILE="/etc/resolv.conf"
BIND_THAT=${ROOT_PATH}${BIND_FILE}
if [ "$1" == "--release" ] ; then
	echo "Release bind to $BIND_FILE at $BIND_THAT"
	umount ${BIND_THAT}
else
	echo "Create bind to $BIND_FILE at $BIND_THAT"
	mount --bind ${BIND_FILE} ${BIND_THAT}
fi

exit 0
